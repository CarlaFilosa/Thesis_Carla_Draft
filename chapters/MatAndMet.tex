\chapter{Materials and Methods}
\label{app:MatAndMet}
\section{Data acquisition}Neural data was recorded with a 64-channel headstage (RHD2164) and interface board (RHD2000) by Intan Technologies LLC at 30 kHz sampling frequency. The same interface was used to record stimulus onset and offset, reward application, licking activity and laser stimulation.
\section{Spike detection}The median voltage trace of the corresponding brain region was subtracted from each recorded trace to reduce noise and movement artifacts affecting all recording sites. The result signal was bandpass-filtered between 300 and 500 Hz. A threshold value for spikes was computed as multiple (7.5x) of the median absolute deviation of the filtered signal ({\color{red}Quiroga 2004- vedere come citare}). To avoid multiple detection of the same multiphasic spike, temporally proximal detected spikes over threshold were pruned by height to a minimum distance of 1 ms. When an event was detected on multiple channels of a tetrode, the timestamp of the highest detected peak was used. Spike waveforms were extracted from -10 to +21 samples around the peak.
\section{Spike sorting}Spike sorting was done with a custom-built graphical user interface in Matlab, using a freely rotatable 3d-point cloud of spike metrics as a basis. Metrics used for clustering included detected peak height or amplitude (and the respective principal components over channels), and the first three principal components of the waveforms for each respective channel when a spike was predominantly recorded on one channel. The quality of single unit clusters was assessed using the mlib toolbox by Maik Stuettgen (version 6, downloaded from Matlab Central) with particular attention to peak height distribution (fraction of lost spikes due to the detection threshold), contamination (fraction of spikes occurring in the refractory period  $\sim$ 5ms) and waveform variance.